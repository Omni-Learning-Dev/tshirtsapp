import{D as b}from"./Default-1XqLegDA.js";import{o as c,c as V,w as a,b as r,i as d,a as t,t as i,f as g,j as v,F as P,l as S}from"./app-DoD6tfwl.js";import{_ as k}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{c as x,b as w,V as F,a as f,d as T}from"./VMain-yLRDDCNh.js";import{V as q}from"./VSpacer-Cfkf7zbK.js";import{V as z,a as _}from"./VRow-DVaIKEa4.js";import{c as m,a as p}from"./VCard-C-0_jRKv.js";import{V as C}from"./VTable-BuLby85c.js";import{a as O}from"./index-CrCfOmGC.js";import{V as M}from"./VForm-B34JYPI8.js";import{V as N}from"./VTextField-CV3swJlr.js";import{V as $}from"./VOverlay-BU_e6B4U.js";import"./VAvatar-BSSSrtoA.js";import"./form-BGQ9tM-g.js";import"./forwardRefs-C-GTDzx5.js";import"./easing-DY7PVvcf.js";import"./lazy-3Nq3dbro.js";const D={layout:b,data(){return{form:this.$inertia.form({amount:null,order_id:this.$page.props.order.id,client_id:this.$page.props.order.client_id,customerPhoneNumber:"0771049950",reason:"payment for order no "+this.$page.props.order.id}),btnloading:!1,valid:!0,loading:!1,loaderMessage:"",retries:10,rules:{customerPhoneNumber:[e=>!!e||"Phone is required",e=>(e?e.length===10:!1)||"Phone number must have 10 characters",e=>/07[1,8,7]\d{7}/.test(e)||"Please enter a valid Econet or OneMoney number"]}}},computed:{totalQuantities(){return this.$page.props.order.quantities.reduce((e,s)=>e+s.quantity,0)},totalUSD(){return this.$page.props.order.quantities.reduce((e,s)=>(this.form.amount=e+this.getPriceForSize(s.size,"usd")*s.quantity,e+this.getPriceForSize(s.size,"usd")*s.quantity),0)},totalRTGS(){return this.$page.props.order.quantities.reduce((e,s)=>e+this.getPriceForSize(s.size,"rtgs")*s.quantity,0)}},methods:{getPriceForSize(e,s="usd"){const n=this.$page.props.prices.find(h=>h.size===e);return n?s==="usd"?n.usd_price:n.rtgs_price:0},async MakePayment(){if(this.form.customerPhoneNumber.length<10)return;this.btnloading=!0;const e=(await axios.post(route("initiatePayment"),this.form)).data;if(e.status==="error"){this.$swal.fire({icon:"error",title:e.message,text:e.reason});return}this.loaderMessage=e.message,this.loading=!0,this.btnloading=!0,console.log(e);var s=new FormData;s.append("ref_num",e.ref_num),this.callbackHandler=setInterval(async()=>{const n=(await axios.post(route("pese-return"),s)).data;if(n.status==="paid")return this.markAsPaid(n.ref_num);if(this.retries<=1)return this.markAsFailed();this.retries--},2e3),this.btnloading=!1},markAsFailed(){this.removeCallback(),this.removeOverlay(),this.$swal.fire({icon:"info",text:"Transaction timed out while waiting for payment."})},markAsPaid(e){this.removeCallback(),this.removeOverlay(),this.$swal.fire({icon:"success",title:"Payment Successful",text:"We have successfully received your payment!. Please save this reference no. "+e}),window.location=route("pese-result",e)},removeCallback(){clearInterval(this.callbackHandler)},removeOverlay(){this.loading=!1},removeSize(e){this.$inertia.delete(route("order.removeSize",{order:this.$page.props.order.id,index:e}),{onSuccess:()=>{this.$toast.success("Size removed successfully!")},onError:()=>{this.$toast.error("Failed to remove size.")}})}}},U=t("thead",null,[t("tr",null,[t("th",{class:"text-left"},"Size"),t("th",{class:"text-left"},"Unit price"),t("th",{class:"text-left"},"Quantity"),t("th",{class:"text-left"},"USD Price"),t("th",{class:"text-left"},"Options")])],-1),B=t("td",null,[t("strong",null,"Totals")],-1),A=t("td",null,[t("strong")],-1),E=t("td",null,null,-1),H=t("h1",null,"Payment Details",-1),I={class:"text-center"},L=["innerHTML"];function Q(e,s,n,h,o,u){return c(),V(x,{class:"mt-5",fluid:""},{default:a(()=>[r(m,{class:"glass pa-5"},{default:a(()=>[r(w,{class:"mb-5 rounded-lg"},{default:a(()=>[r(F,null,{default:a(()=>[d(" Order ")]),_:1}),r(q),r(f,{variant:"flat",class:"mr-3",href:"/order/order-add-client/"+e.$page.props.order.id},{default:a(()=>[d(" Back ")]),_:1},8,["href"])]),_:1}),r(z,null,{default:a(()=>[r(_,{cols:"12",sm:"6"},{default:a(()=>[r(m,null,{default:a(()=>[r(p,null,{default:a(()=>[t("h1",null,"Summary | Order for "+i(e.$page.props.category.name)+"(s)",1),r(C,null,{default:a(()=>[U,t("tbody",null,[(c(!0),g(P,null,v(e.$page.props.order.quantities,(l,y)=>(c(),g("tr",{key:y},[t("td",null,i(l.size),1),t("td",null,"$ "+i(u.getPriceForSize(l.size,"usd")),1),t("td",null,i(l.quantity),1),t("td",null,"$ "+i(u.getPriceForSize(l.size,"usd")*l.quantity),1),t("td",null,[r(f,{color:"error",onClick:j=>u.removeSize(l.id)},{default:a(()=>[r(O,null,{default:a(()=>[d("mdi-trash-can")]),_:1})]),_:2},1032,["onClick"])])]))),128)),t("tr",null,[B,A,t("td",null,[t("strong",null,i(u.totalQuantities)+" Items",1)]),t("td",null,[t("strong",null,"$ "+i(u.totalUSD.toFixed(2)),1)]),E])])]),_:1})]),_:1})]),_:1})]),_:1}),r(_,{cols:"12",sm:"6"},{default:a(()=>[r(m,null,{default:a(()=>[r(M,{modelValue:o.valid,"onUpdate:modelValue":s[1]||(s[1]=l=>o.valid=l),onSubmit:S(u.MakePayment,["prevent"])},{default:a(()=>[r(p,null,{default:a(()=>[H,r(N,{class:"mt-3",label:"Your phone number",modelValue:o.form.customerPhoneNumber,"onUpdate:modelValue":s[0]||(s[0]=l=>o.form.customerPhoneNumber=l),rules:o.rules.customerPhoneNumber},null,8,["modelValue","rules"]),r(f,{loading:o.btnloading,disabled:!o.valid,block:"",class:"mt-5",type:"submit"},{default:a(()=>[d(" Pay Order ")]),_:1},8,["loading","disabled"])]),_:1})]),_:1},8,["modelValue","onSubmit"])]),_:1})]),_:1})]),_:1})]),_:1}),t("div",null,[r($,{class:"border d-flex align-center justify-center",modelValue:o.loading,"onUpdate:modelValue":s[2]||(s[2]=l=>o.loading=l)},{default:a(()=>[r(m,{variant:"flat",width:"500"},{default:a(()=>[r(p,null,{default:a(()=>[t("div",I,[t("p",{innerHTML:o.loaderMessage},null,8,L),r(T,{color:"primary",indeterminate:"",size:"64"},{default:a(()=>[d(i(o.retries),1)]),_:1})])]),_:1})]),_:1})]),_:1},8,["modelValue"])])]),_:1})}const ue=k(D,[["render",Q]]);export{ue as default};
